#Проектирование и Реализация Базы Данных

## 1. Проектирование ER-диаграммы

Проектирование базы данных выполнено на основе технического задания по учету заявок на ремонт бытовой техники. В результате анализа предметной области была разработана **ER-диаграмма**, представленная в файле `Diagram.jpg` [1].

### 1.1. Нормализация и Целостность

База данных приведена к **Третьей Нормальной Форме (3НФ)**. Это достигнуто путем выделения справочников и устранения транзитивных зависимостей.

- **Справочники:** Сущности `equipment_types` (Типы техники) и `statuses` (Статусы) выделены для хранения повторяющихся данных, что устраняет избыточность и обеспечивает 3НФ.
- **Ссылочная Целостность:** Обеспечена с помощью **внешних ключей (FK)** и ограничений:
    - `requests.client_id` ссылается на `clients.client_id` (`ON DELETE RESTRICT`).
    - `requests.master_id` ссылается на `masters.master_id` (`ON DELETE SET NULL`).
    - `requests.type_id` ссылается на `equipment_types.type_id` (`ON DELETE RESTRICT`).
    - `requests.status_id` ссылается на `statuses.status_id` (`ON DELETE RESTRICT`).

### 1.2. Структура Базы Данных

Схема базы данных реализована в файле `table.sql` [2] с использованием **PostgreSQL**.

| Таблица | Назначение | Ключевые Атрибуты | Ограничения |
| :--- | :--- | :--- | :--- |
| `equipment_types` | Справочник типов техники. | `type_id` (PK), `type_name` (UQ). | `type_name` - NOT NULL. |
| `statuses` | Справочник статусов заявок. | `status_id` (PK), `status_name` (UQ). | `status_name` - NOT NULL. |
| `clients` | Информация о клиентах. | `client_id` (PK), `phone_number` (UQ). | `full_name`, `phone_number` - NOT NULL. |
| `masters` | Информация о мастерах. | `master_id` (PK). | `full_name` - NOT NULL. |
| `requests` | Основная таблица заявок. | `request_id` (PK), `client_id` (FK), `master_id` (FK), `type_id` (FK), `status_id` (FK). | `client_id`, `type_id`, `status_id`, `model`, `description` - NOT NULL. |
| `users` | Системные пользователи (для входа). | `user_id` (PK), `login` (UQ). | `login`, `password_hash`, `role`, `fio` - NOT NULL. |
| `comments` | Комментарии к заявкам. | `comment_id` (PK), `master_id` (FK), `request_id` (FK). | `message`, `master_id`, `request_id` - NOT NULL. |

## 2. Реализация Базы Данных и Заполнение Данными

### 2.1. Создание Схемы

Схема создается с помощью скрипта `database_module.py` [3], который выполняет SQL-скрипт `table.sql` [2]. Имена таблиц и полей выполнены в едином стиле (`snake_case` для таблиц и полей, множественное число для таблиц), что соответствует отраслевой документации.

### 2.2. Импорт Данных

Заполнение базы данных осуществляется скриптом `import_data.py` [4], который обрабатывает предоставленные CSV-файлы (`inputDataRequests.csv`, `inputDataUsers.csv`, `inputDataComments.csv`).

- **Механизм Импорта:** Скрипт считывает данные из CSV, выполняет преобразование типов и вставляет записи в соответствующие таблицы (`users`, `requests`, `comments`) с использованием SQL-запросов `INSERT INTO`.
- **Обработка Ошибок:** Предусмотрена обработка ошибок парсинга дат и значений `NULL` (например, для `master_id`).

## 3. Запросы и Отчеты

В модуле `main_app.py` [5] реализованы функции для формирования отчетов, основанных на SQL-запросах:

| Функция | Назначение | SQL-запрос (кратко) |
| :--- | :--- | :--- |
| `calculate_average_repair_time` | Расчет среднего времени ремонта. | `SELECT date_start_work, date_completed FROM requests WHERE status_id = (Выполнена) AND ...` |
| `get_status_report` | Отчет по количеству заявок в каждом статусе. | `SELECT status_name, COUNT(r.request_id) FROM statuses s LEFT JOIN requests r ... GROUP BY s.status_name` |
| `get_master_load_report` | Отчет по загрузке мастеров. | `SELECT m.full_name, COUNT(r.request_id) FROM masters m LEFT JOIN requests r ... GROUP BY m.full_name` |
| `get_master_performance_report` | Отчет о выполненных мастерами заявках. | Сложный `JOIN` между `requests`, `clients`, `equipment_types`, `statuses`, `masters`. |

## 4. Резервное Копирование

Функционал резервного копирования реализован в классе `DBManager` (`database_module.py` [3]) методом `backup_database`, который использует утилиту **`pg_dump`** для создания полного дампа базы данных.

## 5. Регистрация Пользователей и Уровни Доступа

### 5.1. Принцип Регистрации

Принцип регистрации основан на **функциональных обязанностях** пользователей, что отражено в поле `role` таблицы `users`.

| Роль | Функциональные Обязанности |
| :--- | :--- |
| **Администратор** | Полный доступ, управление пользователями, резервное копирование. |
| **Менеджер** | Просмотр всех отчетов, назначение мастеров, управление заявками. |
| **Оператор** | Создание и редактирование заявок, просмотр основных данных. |
| **Мастер** | Просмотр назначенных заявок, изменение статуса, добавление комментариев. |
| **Клиент** | Просмотр статуса своих заявок. |

### 5.2. Реализация Уровней Доступа

Уровни доступа реализованы в `gui.py` [6] путем проверки поля `user_info['role']` перед выполнением критически важных операций или отображением отчетов. Например, отчеты доступны только Администратору и Менеджеру.
